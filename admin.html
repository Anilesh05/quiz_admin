<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center - CyberCrest '26</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .inline-block { display: inline-block; }
        .grid { display: grid; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .uppercase { text-transform: uppercase; }
        .tracking-widest { letter-spacing: 0.1em; }
        .tracking-wider { letter-spacing: 0.05em; }
        .font-bold { font-weight: 700; }
        .min-h-screen { min-height: 100vh; }
        .relative { position: relative; }
        .fixed { position: fixed; }
        .absolute { position: absolute; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .max-w-3xl { max-width: 48rem; }
        .max-w-5xl { max-width: 64rem; }
        .max-h-96 { max-height: 24rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mb-12 { margin-bottom: 48px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }
        .mt-8 { margin-top: 32px; }
        .ml-4 { margin-left: 16px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .p-8 { padding: 32px; }
        .px-2 { padding-left: 8px; padding-right: 8px; }
        .px-4 { padding-left: 16px; padding-right: 16px; }
        .px-6 { padding-left: 24px; padding-right: 24px; }
        .px-12 { padding-left: 48px; padding-right: 48px; }
        .py-1 { padding-top: 4px; padding-bottom: 4px; }
        .py-2 { padding-top: 8px; padding-bottom: 8px; }
        .py-4 { padding-top: 16px; padding-bottom: 16px; }
        .py-8 { padding-top: 32px; padding-bottom: 32px; }
        .space-y-4 > * + * { margin-top: 16px; }
        .z-10 { z-index: 10; }
        .z-9999 { z-index: 9999; }
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-gray-700 { border-color: #374151; }
        .border-gray-800 { border-color: #1f2937; }
        .bg-black { background-color: #000; }
        .bg-green-900 { background-color: #14532d; }
        .bg-opacity-60 { --tw-bg-opacity: 0.6; }
        .bg-opacity-80 { --tw-bg-opacity: 0.8; }
        .text-white { color: #fff; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-green-400 { color: #4ade80; }
        .text-blue-400 { color: #60a5fa; }
        .text-purple-400 { color: #c084fc; }
        .text-yellow-400 { color: #facc15; }
        .text-red-400 { color: #f87171; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-md { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .text-6xl { font-size: 3.75rem; }
        .text-7xl { font-size: 4.5rem; }
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .flex-1 { flex: 1 1 0%; }
        .rounded { border-radius: 0.25rem; }
        
        /* Responsive Grid */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md\:text-xl { font-size: 1.25rem; }
            .md\:text-7xl { font-size: 4.5rem; }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        /* Grid Background */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
        }

        .grid-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, transparent 0%, #000 100%);
        }

        /* Neon Effects */
        .neon-text {
            color: #39FF14;
            text-shadow: 
                0 0 10px rgba(57, 255, 20, 0.8),
                0 0 20px rgba(57, 255, 20, 0.6),
                0 0 30px rgba(57, 255, 20, 0.4);
        }

        .neon-border {
            border: 2px solid #39FF14;
            box-shadow: 
                0 0 10px rgba(57, 255, 20, 0.5),
                inset 0 0 10px rgba(57, 255, 20, 0.2);
        }

        .cyber-btn {
            background: #000;
            border: 2px solid #39FF14;
            color: #39FF14;
            padding: 10px 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.875rem;
        }

        .cyber-btn:hover:not(:disabled) {
            background: #39FF14;
            color: #000;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.8);
        }

        .cyber-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cyber-btn.danger {
            border-color: #ff1744;
            color: #ff1744;
        }

        .cyber-btn.danger:hover:not(:disabled) {
            background: #ff1744;
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 23, 68, 0.8);
        }

        /* Stats Cards */
        .stat-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #39FF14;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(57, 255, 20, 0.1), transparent);
            animation: scan 3s infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Team Cards */
        .team-card {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #39FF14;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .team-card:hover {
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
            transform: translateX(5px);
        }

        .team-card.pending {
            border-color: #FFD700;
            animation: pulse-border 2s infinite;
        }

        .team-card.approved {
            border-color: #39FF14;
        }

        .team-card.rejected {
            border-color: #ff1744;
            opacity: 0.6;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff1744;
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse-notification 1s infinite;
        }

        @keyframes pulse-notification {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Alert Box */
        .alert-box {
            background: rgba(255, 23, 68, 0.2);
            border: 2px solid #ff1744;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #39FF14;
            border-radius: 5px;
        }

        /* Glitch Effect */
        .glitch {
            position: relative;
            display: inline-block;
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .glitch::before {
            left: 2px;
            text-shadow: -2px 0 #ff00de;
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim 3s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -2px 0 #00fff9;
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            20% { clip: rect(60px, 9999px, 5px, 0); }
            40% { clip: rect(80px, 9999px, 62px, 0); }
            60% { clip: rect(23px, 9999px, 99px, 0); }
            80% { clip: rect(45px, 9999px, 12px, 0); }
            100% { clip: rect(70px, 9999px, 38px, 0); }
        }

        .master-trigger {
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            border: 3px solid #39FF14;
            padding: 24px;
            text-align: center;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.4);
        }

        .master-trigger.active {
            animation: trigger-pulse 1s infinite;
        }

        @keyframes trigger-pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(57, 255, 20, 0.4); }
            50% { box-shadow: 0 0 50px rgba(57, 255, 20, 0.8); }
        }

        .hover\:text-white:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Background Grid -->
    <div class="grid-bg"></div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen p-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold mb-3 glitch neon-text" data-text="ADMIN COMMAND CENTER">ADMIN COMMAND CENTER</h1>
            <p class="text-lg tracking-widest text-gray-400">CYBERCREST'26 - QUIZ BYTES</p>
            <div class="mt-4 inline-block px-4 py-2 neon-border">
                <span class="text-sm font-bold neon-text" id="adminStatus">SYSTEM ONLINE</span>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="grid md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">PENDING REQUESTS</p>
                <p class="text-4xl font-bold neon-text" id="pendingCount">0</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">APPROVED TEAMS</p>
                <p class="text-4xl font-bold text-green-400" id="approvedCount">0</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">ACTIVE PARTICIPANTS</p>
                <p class="text-4xl font-bold text-blue-400" id="activeCount">0</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">COMPLETED</p>
                <p class="text-4xl font-bold text-purple-400" id="completedCount">0</p>
            </div>
        </div>

        <!-- Master Control -->
        <div class="master-trigger mb-8" id="masterControl">
            <h2 class="text-2xl font-bold mb-4 neon-text">MASTER QUIZ TRIGGER</h2>
            <p class="text-sm text-gray-400 mb-4">Initiates 30-minute countdown for all approved teams</p>
            <button id="startQuizBtn" class="cyber-btn text-xl px-12 py-4" disabled>
                üöÄ LAUNCH QUIZ SEQUENCE
            </button>
            <div id="quizTimer" class="mt-4 hidden">
                <p class="text-xl text-gray-400">QUIZ IN PROGRESS</p>
                <p class="text-4xl font-bold neon-text" id="masterTimer">30:00</p>
            </div>
        </div>

        <!-- Cheat Alerts -->
        <div id="cheatAlerts" class="mb-8"></div>

        <!-- Control Panels -->
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Pending Requests -->
            <div>
                <div class="neon-border p-6 bg-black bg-opacity-80">
                    <div class="flex justify-between items-center mb-4 relative">
                        <h2 class="text-2xl font-bold neon-text">INCOMING REQUESTS</h2>
                        <div class="notification-badge hidden" id="pendingBadge">0</div>
                    </div>
                    <div id="pendingList" class="max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">No pending requests</p>
                    </div>
                </div>
            </div>

            <!-- Approved Teams -->
            <div>
                <div class="neon-border p-6 bg-black bg-opacity-80">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-green-400">CLEARED TEAMS</h2>
                        <button id="exportBtn" class="cyber-btn">
                            üìä EXPORT CSV
                        </button>
                    </div>
                    <div id="approvedList" class="max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">No approved teams yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="mt-8">
            <div class="neon-border p-6 bg-black bg-opacity-80">
                <h2 class="text-2xl font-bold mb-4 neon-text">LIVE RESULTS FEED</h2>
                <div class="overflow-x-auto">
                    <table class="w-full" id="resultsTable">
                        <thead>
                            <tr class="border-b-2 border-green-400">
                                <th class="text-left p-3 text-green-400">RANK</th>
                                <th class="text-left p-3 text-green-400">TEAM</th>
                                <th class="text-left p-3 text-green-400">SCORE</th>
                                <th class="text-left p-3 text-green-400">TIME</th>
                                <th class="text-left p-3 text-green-400">VIOLATIONS</th>
                                <th class="text-left p-3 text-green-400">STATUS</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="6" class="text-center p-8 text-gray-500">Waiting for submissions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        // Wait for PeerJS to load
        window.addEventListener('load', function() {
            if (typeof Peer === 'undefined') {
                console.error('PeerJS failed to load');
                alert('Connection library failed to load. Please refresh the page.');
                return;
            }

            initializeAdmin();
        });

        function initializeAdmin() {
            // PeerJS Setup - Fixed Admin ID
            const peer = new Peer('admin-cybercrest-26');
            let connections = {};
            let teams = {
                pending: [],
                approved: [],
                rejected: [],
                results: []
            };

            let quizStarted = false;
            let masterTimerInterval = null;

            // Load saved state
            function loadState() {
                const saved = localStorage.getItem('adminState');
                if (saved) {
                    teams = JSON.parse(saved);
                    renderAllLists();
                    updateStats();
                    
                    // Check if quiz was started
                    if (teams.quizStartTime) {
                        quizStarted = true;
                        resumeMasterTimer();
                    }
                }
            }

            // Save state
            function saveState() {
                localStorage.setItem('adminState', JSON.stringify(teams));
            }

            peer.on('open', (id) => {
                console.log('Admin ID:', id);
                document.getElementById('adminStatus').textContent = `ONLINE - ID: ${id}`;
                loadState();
            });

            peer.on('connection', (conn) => {
                console.log('New connection from:', conn.peer);
                connections[conn.peer] = conn;

                conn.on('data', (data) => {
                    console.log('Received:', data);
                    handleIncomingData(data, conn);
                });

                conn.on('close', () => {
                    console.log('Connection closed:', conn.peer);
                });
            });

            function handleIncomingData(data, conn) {
                switch(data.type) {
                    case 'registration':
                        handleRegistration(data.data, conn);
                        break;
                    case 'cancel_registration':
                        handleCancellation(data.studentId);
                        break;
                    case 'submit_quiz':
                        handleQuizSubmission(data);
                        break;
                    case 'cheat_detected':
                        handleCheatAlert(data);
                        break;
                }
            }

            function handleRegistration(teamData, conn) {
                // Check if already exists
                const exists = teams.pending.find(t => t.studentId === teamData.studentId) ||
                              teams.approved.find(t => t.studentId === teamData.studentId);
                
                if (!exists) {
                    teams.pending.push(teamData);
                    saveState();
                    renderPendingList();
                    updateStats();
                    playNotificationSound();
                }
            }

            function handleCancellation(studentId) {
                teams.pending = teams.pending.filter(t => t.studentId !== studentId);
                saveState();
                renderPendingList();
                updateStats();
            }

            function handleQuizSubmission(data) {
                const team = teams.approved.find(t => t.studentId === data.studentId);
                if (team) {
                    const result = {
                        ...team,
                        score: data.score,
                        completionTime: data.completionTime,
                        tabSwitches: data.tabSwitches,
                        submittedAt: Date.now()
                    };
                    
                    teams.results.push(result);
                    saveState();
                    renderResultsTable();
                    updateStats();
                }
            }

            function handleCheatAlert(data) {
                const alertsContainer = document.getElementById('cheatAlerts');
                const team = teams.approved.find(t => t.studentId === data.studentId);
                
                if (team) {
                    const alert = document.createElement('div');
                    alert.className = 'alert-box';
                    alert.innerHTML = `
                        <div>
                            <span class="font-bold text-red-400">‚ö†Ô∏è SECURITY ALERT</span>
                            <span class="ml-4">${team.teamName} - Tab Switch Detected (Total: ${data.tabSwitches})</span>
                        </div>
                        <button onclick="this.parentElement.remove()" class="text-gray-400 hover-text-white">‚úï</button>
                    `;
                    alertsContainer.appendChild(alert);
                }
            }

            function approveTeam(studentId) {
                const teamIndex = teams.pending.findIndex(t => t.studentId === studentId);
                if (teamIndex !== -1) {
                    const team = teams.pending.splice(teamIndex, 1)[0];
                    teams.approved.push(team);
                    
                    // Send approval to student
                    if (connections[studentId]) {
                        connections[studentId].send({
                            type: 'approved',
                            teamData: team
                        });
                    }
                    
                    saveState();
                    renderAllLists();
                    updateStats();
                    checkMasterTrigger();
                }
            }

            function rejectTeam(studentId) {
                const teamIndex = teams.pending.findIndex(t => t.studentId === studentId);
                if (teamIndex !== -1) {
                    const team = teams.pending.splice(teamIndex, 1)[0];
                    teams.rejected.push(team);
                    
                    // Send rejection to student
                    if (connections[studentId]) {
                        connections[studentId].send({
                            type: 'rejected'
                        });
                    }
                    
                    saveState();
                    renderAllLists();
                    updateStats();
                }
            }

            function renderPendingList() {
                const container = document.getElementById('pendingList');
                
                if (teams.pending.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No pending requests</p>';
                    document.getElementById('pendingBadge').classList.add('hidden');
                    return;
                }

                document.getElementById('pendingBadge').classList.remove('hidden');
                document.getElementById('pendingBadge').textContent = teams.pending.length;

                container.innerHTML = teams.pending.map(team => `
                    <div class="team-card pending">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-yellow-400">${team.teamName}</h3>
                                <p class="text-sm text-gray-400">${team.college}</p>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(team.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>
                                <p class="text-gray-400">P1:</p>
                                <p class="text-white">${team.p1Name}</p>
                                <p class="text-gray-500 text-xs">${team.p1Email}</p>
                            </div>
                            <div>
                                <p class="text-gray-400">P2:</p>
                                <p class="text-white">${team.p2Name}</p>
                                <p class="text-gray-500 text-xs">${team.p2Email}</p>
                            </div>
                        </div>
                        <div class="text-sm mb-3">
                            <p class="text-gray-400">Mobile: <span class="text-white">${team.mobile}</span></p>
                            <p class="text-gray-400">Dept: <span class="text-white">${team.department}</span></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveTeam('${team.studentId}')" class="cyber-btn flex-1">
                                ‚úì APPROVE
                            </button>
                            <button onclick="rejectTeam('${team.studentId}')" class="cyber-btn danger flex-1">
                                ‚úï REJECT
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            function renderApprovedList() {
                const container = document.getElementById('approvedList');
                
                if (teams.approved.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No approved teams yet</p>';
                    return;
                }

                container.innerHTML = teams.approved.map(team => `
                    <div class="team-card approved">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-green-400">${team.teamName}</h3>
                            <span class="text-xs px-2 py-1 bg-green-900 text-green-400 rounded">CLEARED</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-1">${team.college} - ${team.department}</p>
                        <div class="text-xs text-gray-500">
                            <p>${team.p1Name} & ${team.p2Name}</p>
                        </div>
                    </div>
                `).join('');
            }

            function renderResultsTable() {
                const tbody = document.getElementById('resultsBody');
                
                if (teams.results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Waiting for submissions...</td></tr>';
                    return;
                }

                // Sort by score (desc) then by time (asc)
                const sorted = [...teams.results].sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.completionTime - b.completionTime;
                });

                tbody.innerHTML = sorted.map((result, idx) => {
                    const minutes = Math.floor(result.completionTime / 60);
                    const seconds = result.completionTime % 60;
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    
                    let statusClass = 'text-green-400';
                    let statusText = 'CLEAN';
                    
                    if (result.tabSwitches > 0) {
                        statusClass = 'text-red-400';
                        statusText = 'FLAGGED';
                    }
                    
                    return `
                        <tr class="border-b border-gray-800">
                            <td class="p-3 font-bold ${idx < 10 ? 'text-yellow-400' : 'text-gray-400'}">#${idx + 1}</td>
                            <td class="p-3">${result.teamName}</td>
                            <td class="p-3 font-bold text-green-400">${result.score}/25</td>
                            <td class="p-3">${timeStr}</td>
                            <td class="p-3 ${result.tabSwitches > 0 ? 'text-red-400' : 'text-gray-400'}">${result.tabSwitches}</td>
                            <td class="p-3 ${statusClass}">${statusText}</td>
                        </tr>
                    `;
                }).join('');
            }

            function renderAllLists() {
                renderPendingList();
                renderApprovedList();
                renderResultsTable();
            }

            function updateStats() {
                document.getElementById('pendingCount').textContent = teams.pending.length;
                document.getElementById('approvedCount').textContent = teams.approved.length;
                document.getElementById('activeCount').textContent = teams.approved.length - teams.results.length;
                document.getElementById('completedCount').textContent = teams.results.length;
            }

            function checkMasterTrigger() {
                const btn = document.getElementById('startQuizBtn');
                btn.disabled = teams.approved.length === 0 || quizStarted;
            }

            // Master Quiz Trigger
            document.getElementById('startQuizBtn').addEventListener('click', () => {
                if (confirm(`Start quiz for ${teams.approved.length} teams?`)) {
                    quizStarted = true;
                    teams.quizStartTime = Date.now();
                    saveState();
                    
                    // Send start signal to all approved teams
                    teams.approved.forEach(team => {
                        if (connections[team.studentId]) {
                            connections[team.studentId].send({
                                type: 'start_quiz'
                            });
                        }
                    });
                    
                    startMasterTimer();
                    document.getElementById('startQuizBtn').disabled = true;
                    document.getElementById('masterControl').classList.add('active');
                }
            });

            function startMasterTimer() {
                document.getElementById('quizTimer').classList.remove('hidden');
                let timeLeft = 30 * 60;
                
                masterTimerInterval = setInterval(() => {
                    timeLeft--;
                    
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    document.getElementById('masterTimer').textContent = 
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(masterTimerInterval);
                        document.getElementById('masterTimer').textContent = 'COMPLETED';
                    }
                }, 1000);
            }

            function resumeMasterTimer() {
                const elapsed = Math.floor((Date.now() - teams.quizStartTime) / 1000);
                if (elapsed < 30 * 60) {
                    document.getElementById('quizTimer').classList.remove('hidden');
                    let timeLeft = (30 * 60) - elapsed;
                    
                    masterTimerInterval = setInterval(() => {
                        timeLeft--;
                        
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        document.getElementById('masterTimer').textContent = 
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        if (timeLeft <= 0) {
                            clearInterval(masterTimerInterval);
                            document.getElementById('masterTimer').textContent = 'COMPLETED';
                        }
                    }, 1000);
                }
                document.getElementById('startQuizBtn').disabled = true;
            }

            // Export CSV
            document.getElementById('exportBtn').addEventListener('click', () => {
                if (teams.results.length === 0) {
                    alert('No results to export yet!');
                    return;
                }

                // Sort results
                const sorted = [...teams.results].sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.completionTime - b.completionTime;
                });

                // Create CSV
                let csv = 'Rank,Team Name,College,Department,P1 Name,P2 Name,Score,Completion Time (seconds),Tab Switches,Status\n';
                
                sorted.forEach((result, idx) => {
                    const status = result.tabSwitches > 0 ? 'FLAGGED' : 'CLEAN';
                    csv += `${idx + 1},"${result.teamName}","${result.college}","${result.department}","${result.p1Name}","${result.p2Name}",${result.score},${result.completionTime},${result.tabSwitches},${status}\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CyberCrest26_QuizBytes_Results_${Date.now()}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            });

            function playNotificationSound() {
                // Simple beep using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            // Make functions globally available
            window.approveTeam = approveTeam;
            window.rejectTeam = rejectTeam;
        }
    </script>
</body>
</html>

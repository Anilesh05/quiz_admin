<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center - CyberCrest '26</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --cyber-green: #39FF14;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'JetBrains Mono', monospace; background: #000; color: #fff; overflow-x: hidden; }
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }
        .site-logo {
            width: 120px;          /* adjust size if needed */
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(57, 255, 20, 0.8));
        }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .min-h-screen { min-height: 100vh; }
        .relative { position: relative; }
        .fixed { position: fixed; }
        .w-full { width: 100%; }
        .max-h-96 { max-height: 24rem; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-4 { margin-top: 16px; }
        .ml-4 { margin-left: 16px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .px-4 { padding-left: 16px; padding-right: 16px; }
        .px-6 { padding-left: 24px; padding-right: 24px; }
        .px-8 { padding-left: 32px; padding-right: 32px; }
        .py-1 { padding-top: 4px; padding-bottom: 4px; }
        .py-2 { padding-top: 8px; padding-bottom: 8px; }
        .py-4 { padding-top: 16px; padding-bottom: 16px; }
        .z-10 { z-index: 10; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-gray-800 { border-color: #1f2937; }
        .bg-black { background-color: #000; }
        .bg-green-900 { background-color: #14532d; }
        .text-white { color: #fff; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-green-400 { color: #4ade80; }
        .text-blue-400 { color: #60a5fa; }
        .text-purple-400 { color: #c084fc; }
        .text-yellow-400 { color: #facc15; }
        .text-red-400 { color: #f87171; }
        .text-orange-400 { color: #fb923c; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .text-6xl { font-size: 3.75rem; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .flex-1 { flex: 1; }
        .rounded { border-radius: 0.25rem; }
        
        @media (min-width: 768px) {
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px) {
            .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        /* 3D Grid Background */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            perspective: 500px;
            overflow: hidden;
        }
        .grid-plane {
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(var(--cyber-green) 1px, transparent 1px),
                linear-gradient(90deg, var(--cyber-green) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(75deg);
            animation: gridMove 20s linear infinite;
            opacity: 0.15;
        }
        @keyframes gridMove {
            0% { transform: rotateX(75deg) translateY(0); }
            100% { transform: rotateX(75deg) translateY(60px); }
        }

        .neon-text { color: #39FF14; text-shadow: 0 0 10px rgba(57, 255, 20, 0.8), 0 0 20px rgba(57, 255, 20, 0.6); }
        .neon-border { border: 2px solid #39FF14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.5), inset 0 0 10px rgba(57, 255, 20, 0.2); }
        
        .cyber-btn {
            background: #000;
            border: 2px solid #39FF14;
            color: #39FF14;
            padding: 10px 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.875rem;
        }
        .cyber-btn:hover:not(:disabled) { background: #39FF14; color: #000; box-shadow: 0 0 20px rgba(57, 255, 20, 0.8); }
        .cyber-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .cyber-btn.danger { border-color: #ff1744; color: #ff1744; }
        .cyber-btn.danger:hover:not(:disabled) { background: #ff1744; color: #fff; }

        .stat-card { background: rgba(0, 0, 0, 0.8); border: 2px solid #39FF14; padding: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(57, 255, 20, 0.1), transparent); animation: scan 3s infinite; }
        @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }

        .team-card { background: rgba(0, 0, 0, 0.9); border: 2px solid #39FF14; padding: 16px; margin-bottom: 12px; transition: all 0.3s; }
        .team-card:hover { box-shadow: 0 0 15px rgba(57, 255, 20, 0.5); transform: translateX(5px); }
        .team-card.pending { border-color: #FFD700; animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); } }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff1744;
            color: #fff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            animation: pulse-notification 1s infinite;
        }
        @keyframes pulse-notification { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        .yellow-card-badge {
            background: #ffa500;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: pulse-yellow 1.5s infinite;
        }
        @keyframes pulse-yellow { 0%, 100% { box-shadow: 0 0 10px rgba(255, 165, 0, 0.5); } 50% { box-shadow: 0 0 20px rgba(255, 165, 0, 1); } }

        .alert-box { background: rgba(255, 165, 0, 0.2); border: 2px solid #ffa500; padding: 12px 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .glitch { position: relative; display: inline-block; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .glitch::before { left: 2px; text-shadow: -2px 0 #ff00de; animation: glitch-anim 3s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -2px 0 #00fff9; animation: glitch-anim 2.5s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { clip: rect(31px, 9999px, 94px, 0); } 50% { clip: rect(60px, 9999px, 5px, 0); } 100% { clip: rect(70px, 9999px, 38px, 0); } }
        .master-trigger { background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); border: 3px solid #39FF14; padding: 30px; margin-bottom: 30px; text-align: center; box-shadow: 0 0 30px rgba(57, 255, 20, 0.4); }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #39FF14; border-radius: 5px; }
    </style>
</head>
<body onclick="startAudio()">
    <audio id="bg-audio" loop>
        <source src="Music.mp3" type="audio/mpeg">
    </audio>
    <div class="grid-bg">
        <div class="grid-plane"></div>
    </div>
    <div class="relative z-10 min-h-screen p-6">
        <header class="text-center mb-8">
            <!-- LOGO -->
            <div class="logo-container">
                <img src="Logo.png" alt="CyberCrest Logo" class="site-logo">
            </div>
            <h1 class="text-5xl md:text-6xl font-bold mb-3 glitch neon-text" data-text="ADMIN COMMAND CENTER">ADMIN COMMAND CENTER</h1>
            <p class="text-lg text-gray-400">CYBERCREST'26 - QUIZ BYTES</p>
            <div class="mt-4 px-4 py-2 neon-border" style="display: inline-block;">
                <span class="text-sm font-bold neon-text" id="adminStatus">INITIALIZING...</span>
            </div>
        </header>

        <div class="grid md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card relative">
                <p class="text-sm text-gray-400 mb-1">PENDING REQUESTS</p>
                <p class="text-4xl font-bold neon-text" id="pendingCount">0</p>
                <div id="pendingBadge" class="notification-badge hidden">0</div>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">APPROVED TEAMS</p>
                <p class="text-4xl font-bold text-green-400" id="approvedCount">0</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">ACTIVE</p>
                <p class="text-4xl font-bold text-blue-400" id="activeCount">0</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-400 mb-1">COMPLETED</p>
                <p class="text-4xl font-bold text-purple-400" id="completedCount">0</p>
            </div>
        </div>

        <div class="master-trigger mb-8">
            <h2 class="text-2xl font-bold mb-4 neon-text">MASTER CONTROL PANEL</h2>
            <div class="flex gap-4 justify-center mb-4" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="approveAllBtn" class="cyber-btn text-xl px-8 py-4" disabled>‚úì APPROVE ALL</button>
                <button id="startQuizBtn" class="cyber-btn text-xl px-8 py-4" disabled>üöÄ LAUNCH QUIZ FOR ALL</button>
                <button id="clearTeamsBtn" class="cyber-btn danger text-xl px-8 py-4">üóëÔ∏è CLEAR ALL TEAMS</button>
            </div>
            <div id="quizTimer" class="mt-4 hidden">
                <p class="text-xl text-gray-400">QUIZ IN PROGRESS</p>
                <p class="text-4xl font-bold neon-text" id="masterTimer">30:00</p>
            </div>
        </div>

        <div id="yellowCardAlerts" class="mb-8"></div>

        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <div>
                <div class="neon-border p-6 bg-black" style="background-color: rgba(0,0,0,0.8);">
                    <h2 class="text-2xl font-bold neon-text mb-4">INCOMING REQUESTS</h2>
                    <div id="pendingList" class="max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8" style="padding: 32px 0;">No pending requests</p>
                    </div>
                </div>
            </div>

            <div>
                <div class="neon-border p-6 bg-black" style="background-color: rgba(0,0,0,0.8);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-green-400">APPROVED TEAMS</h2>
                        <button id="exportExcelBtn" class="cyber-btn">
                            üìä DOWNLOAD RESULTS
                        </button>
                    </div>
                    <div id="approvedList" class="max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8" style="padding: 32px 0;">No approved teams</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <div class="neon-border p-6 bg-black" style="background-color: rgba(0,0,0,0.8);">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold neon-text">LIVE RESULTS FEED</h2>
                    <button id="downloadDetailedBtn" class="cyber-btn">üì• DOWNLOAD DETAILED RESULTS</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2" style="border-color: #4ade80;">
                                <th class="text-left p-3 text-green-400">RANK</th>
                                <th class="text-left p-3 text-green-400">TEAM</th>
                                <th class="text-left p-3 text-green-400">COLLEGE</th>
                                <th class="text-left p-3 text-green-400">SCORE</th>
                                <th class="text-left p-3 text-green-400">TIME</th>
                                <th class="text-left p-3 text-green-400">YELLOW CARDS</th>
                                <th class="text-left p-3 text-green-400">STATUS</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr><td colspan="7" class="text-center p-8 text-gray-500">Waiting...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        window.addEventListener('load', function() {
            if (typeof Peer === 'undefined') {
                alert('Connection library failed to load. Please refresh.');
                return;
            }
            initializeAdmin();
        });

        function initializeAdmin() {
            const peer = new Peer('admin-cybercrest-26');
            let connections = {};
            let teams = { pending: [], approved: [], results: [] };
            let quizStarted = false;
            let serverStartTime = null;
            let masterTimerInterval = null;

            function loadState() {
                const saved = localStorage.getItem('adminState');
                if (saved) {
                    try {
                        teams = JSON.parse(saved);
                        renderAllLists();
                        updateStats();
                        
                        if (teams.quizStartTime) {
                            quizStarted = true;
                            serverStartTime = teams.quizStartTime;
                            resumeMasterTimer();
                            document.getElementById('startQuizBtn').disabled = true;
                        } else {
                            checkBulkButtons();
                        }
                    } catch (e) {
                        console.error('Error loading state:', e);
                    }
                }
            }

            function saveState() {
                try {
                    const state = {
                        pending: teams.pending,
                        approved: teams.approved,
                        results: teams.results,
                        quizStartTime: teams.quizStartTime
                    };
                    localStorage.setItem('adminState', JSON.stringify(state));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            }

            peer.on('open', (id) => {
                console.log('Admin ID:', id);
                document.getElementById('adminStatus').textContent = `ONLINE - ID: ${id}`;
                loadState();
            });

            peer.on('connection', (conn) => {
                connections[conn.peer] = conn;

                conn.on('data', (data) => {
                    handleIncomingData(data, conn);
                });

                conn.on('close', () => {
                    delete connections[conn.peer];
                });
            });

            function handleIncomingData(data, conn) {
                switch(data.type) {
                    case 'registration':
                        handleRegistration(data.data);
                        break;
                    case 'cancel_registration':
                        handleCancellation(data.sessionId);
                        break;
                    case 'check_approval':
                        checkAndSendApproval(data.sessionId, conn);
                        break;
                    case 'submit_quiz':
                        handleQuizSubmission(data);
                        break;
                    case 'yellow_card':
                        handleYellowCard(data);
                        break;
                }
            }

            function handleRegistration(teamData) {
                const exists = teams.pending.find(t => t.sessionId === teamData.sessionId) ||
                              teams.approved.find(t => t.sessionId === teamData.sessionId);
                
                if (!exists) {
                    teams.pending.push(teamData);
                    saveState();
                    renderPendingList();
                    updateStats();
                    playNotificationSound();
                }
            }

            function handleCancellation(sessionId) {
                teams.pending = teams.pending.filter(t => t.sessionId !== sessionId);
                saveState();
                renderPendingList();
                updateStats();
            }

            function checkAndSendApproval(sessionId, conn) {
                const team = teams.approved.find(t => t.sessionId === sessionId);
                if (team && conn) {
                    conn.send({ type: 'approved' });
                }
            }

            function handleQuizSubmission(data) {
                const team = teams.approved.find(t => t.sessionId === data.sessionId);
                if (team && !teams.results.find(r => r.sessionId === data.sessionId)) {
                    teams.results.push({
                        ...team,
                        score: data.score,
                        completionTime: data.completionTime,
                        yellowCards: data.yellowCards,
                        detailedAnswers: data.detailedAnswers,
                        submittedAt: Date.now()
                    });
                    saveState();
                    renderResultsTable();
                    updateStats();
                }
            }

            function handleYellowCard(data) {
                const container = document.getElementById('yellowCardAlerts');
                const alert = document.createElement('div');
                alert.className = 'alert-box';
                alert.innerHTML = `
                    <div>
                        <span class="font-bold text-orange-400">‚ö†Ô∏è YELLOW CARD</span>
                        <span class="ml-4">${data.teamName} - Focus Lost (Total: ${data.totalCards})</span>
                        <span class="ml-4 text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-gray-400">‚úï</button>
                `;
                container.appendChild(alert);
            }

            function approveTeam(sessionId) {
                const idx = teams.pending.findIndex(t => t.sessionId === sessionId);
                if (idx !== -1) {
                    const team = teams.pending.splice(idx, 1)[0];
                    teams.approved.push(team);
                    
                    const conn = connections[team.peerId];
                    if (conn) {
                        conn.send({ type: 'approved' });
                    }
                    
                    saveState();
                    renderAllLists();
                    updateStats();
                    checkBulkButtons();
                }
            }

            function clearTeam(sessionId) {
                if (confirm('Remove this team?')) {
                    teams.approved = teams.approved.filter(t => t.sessionId !== sessionId);
                    saveState();
                    renderAllLists();
                    updateStats();
                    checkBulkButtons();
                }
            }

            function renderPendingList() {
                const container = document.getElementById('pendingList');
                
                if (teams.pending.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center" style="padding: 32px 0;">No pending requests</p>';
                    document.getElementById('pendingBadge').classList.add('hidden');
                    return;
                }

                document.getElementById('pendingBadge').classList.remove('hidden');
                document.getElementById('pendingBadge').textContent = teams.pending.length;

                container.innerHTML = teams.pending.map(team => `
                    <div class="team-card pending" data-session="${team.sessionId}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-yellow-400">${team.teamName}</h3>
                                <p class="text-sm text-gray-400">${team.college}</p>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(team.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="text-sm mb-3" style="background: rgba(0,0,0,0.5); padding: 12px; border: 1px solid #374151;">
                            <p class="text-gray-400 mb-2"><strong>Participants:</strong></p>
                            <p class="text-white">1. ${team.p1Name} (${team.p1Email})</p>
                            <p class="text-white">2. ${team.p2Name} (${team.p2Email})</p>
                            <p class="text-gray-400 mt-2"><strong>Mobile:</strong> ${team.mobile}</p>
                            <p class="text-gray-400"><strong>Department:</strong> ${team.department}</p>
                        </div>
                        <button onclick="approveTeam('${team.sessionId}')" class="cyber-btn w-full">‚úì APPROVE</button>
                    </div>
                `).join('');
            }

            function renderApprovedList() {
                const container = document.getElementById('approvedList');
                
                if (teams.approved.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center" style="padding: 32px 0;">No approved teams</p>';
                    return;
                }

                container.innerHTML = teams.approved.map(team => `
                    <div class="team-card" style="border-color: #4ade80;">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-green-400">${team.teamName}</h3>
                            <button onclick="clearTeam('${team.sessionId}')" class="cyber-btn danger" style="padding: 4px 12px; font-size: 0.75rem;">CLEAR</button>
                        </div>
                        <p class="text-sm text-gray-400">${team.college} - ${team.department}</p>
                        <p class="text-xs text-gray-500">${team.p1Name} & ${team.p2Name}</p>
                    </div>
                `).join('');
            }

            function renderResultsTable() {
                const tbody = document.getElementById('resultsBody');
                
                if (teams.results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Waiting...</td></tr>';
                    return;
                }

                const sorted = [...teams.results].sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.completionTime - b.completionTime;
                });

                tbody.innerHTML = sorted.map((r, idx) => {
                    const min = Math.floor(r.completionTime / 60);
                    const sec = r.completionTime % 60;
                    const statusClass = r.yellowCards > 0 ? 'text-orange-400' : 'text-green-400';
                    const statusText = r.yellowCards > 0 ? 'FLAGGED' : 'CLEAN';
                    
                    return `
                        <tr class="border-b border-gray-800">
                            <td class="p-3 font-bold ${idx < 10 ? 'text-yellow-400' : 'text-gray-400'}">#${idx + 1}</td>
                            <td class="p-3">${r.teamName}</td>
                            <td class="p-3 text-sm">${r.college}</td>
                            <td class="p-3 font-bold text-green-400">${r.score}/30</td>
                            <td class="p-3">${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}</td>
                            <td class="p-3 ${r.yellowCards > 0 ? 'text-orange-400' : 'text-gray-400'}">${r.yellowCards}</td>
                            <td class="p-3 ${statusClass}">${statusText}</td>
                        </tr>
                    `;
                }).join('');
            }

            function renderAllLists() {
                renderPendingList();
                renderApprovedList();
                renderResultsTable();
            }

            function updateStats() {
                document.getElementById('pendingCount').textContent = teams.pending.length;
                document.getElementById('approvedCount').textContent = teams.approved.length;
                document.getElementById('activeCount').textContent = teams.approved.length - teams.results.length;
                document.getElementById('completedCount').textContent = teams.results.length;
            }

            function checkBulkButtons() {
                document.getElementById('approveAllBtn').disabled = teams.pending.length === 0;
                document.getElementById('startQuizBtn').disabled = teams.approved.length === 0 || quizStarted;
            }

            document.getElementById('approveAllBtn').addEventListener('click', () => {
                if (confirm(`Approve all ${teams.pending.length} pending teams?`)) {
                    teams.pending.forEach(team => {
                        teams.approved.push(team);
                        const conn = connections[team.peerId];
                        if (conn) conn.send({ type: 'approved' });
                    });
                    teams.pending = [];
                    saveState();
                    renderAllLists();
                    updateStats();
                    checkBulkButtons();
                }
            });

            document.getElementById('startQuizBtn').addEventListener('click', () => {
                if (confirm(`Start quiz for ${teams.approved.length} teams?`)) {
                    quizStarted = true;
                    serverStartTime = Date.now();
                    teams.quizStartTime = serverStartTime;
                    saveState();
                    
                    teams.approved.forEach(team => {
                        const conn = connections[team.peerId];
                        if (conn) {
                            conn.send({ type: 'start_quiz', serverStartTime: serverStartTime });
                        }
                    });
                    
                    startMasterTimer();
                    document.getElementById('startQuizBtn').disabled = true;
                }
            });

            document.getElementById('clearTeamsBtn').addEventListener('click', () => {
                if (confirm('‚ö†Ô∏è WARNING: Delete ALL teams and reset?')) {
                    if (confirm('Cannot be undone. Continue?')) {
                        Object.values(connections).forEach(c => { try { c.close(); } catch (e) {} });
                        connections = {};
                        teams = { pending: [], approved: [], results: [] };
                        quizStarted = false;
                        serverStartTime = null;
                        if (masterTimerInterval) clearInterval(masterTimerInterval);
                        localStorage.removeItem('adminState');
                        document.getElementById('quizTimer').classList.add('hidden');
                        document.getElementById('yellowCardAlerts').innerHTML = '';
                        renderAllLists();
                        updateStats();
                        checkBulkButtons();
                        alert('System reset complete!');
                    }
                }
            });

            function startMasterTimer() {
                document.getElementById('quizTimer').classList.remove('hidden');
                let timeLeft = 30 * 60;
                masterTimerInterval = setInterval(() => {
                    timeLeft--;
                    const min = Math.floor(timeLeft / 60);
                    const sec = timeLeft % 60;
                    document.getElementById('masterTimer').textContent = 
                        `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                    if (timeLeft <= 0) {
                        clearInterval(masterTimerInterval);
                        document.getElementById('masterTimer').textContent = 'COMPLETED';
                    }
                }, 1000);
            }

            function resumeMasterTimer() {
                const elapsed = Math.floor((Date.now() - serverStartTime) / 1000);
                if (elapsed < 30 * 60) {
                    document.getElementById('quizTimer').classList.remove('hidden');
                    let timeLeft = (30 * 60) - elapsed;
                    masterTimerInterval = setInterval(() => {
                        timeLeft--;
                        const min = Math.floor(timeLeft / 60);
                        const sec = timeLeft % 60;
                        document.getElementById('masterTimer').textContent = 
                            `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        if (timeLeft <= 0) {
                            clearInterval(masterTimerInterval);
                            document.getElementById('masterTimer').textContent = 'COMPLETED';
                        }
                    }, 1000);
                }
            }
            
            // Download Results (Excel)
            document.getElementById('exportExcelBtn').addEventListener('click', () => {
                if (teams.results.length === 0) {
                    alert('No results to export!');
                    return;
                }

                const sorted = [...teams.results].sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.completionTime - b.completionTime;
                });

                const wsData = [
                    ['CYBERCREST\'26 - QUIZ BYTES - RESULTS'],
                    ['Generated: ' + new Date().toLocaleString()],
                    [],
                    ['Rank', 'Team', 'P1', 'P2', 'Mobile', 'College', 'Dept', 'Score', 'Time (mm:ss)', 'Yellow Cards', 'Status']
                ];

                sorted.forEach((r, i) => {
                    const min = Math.floor(r.completionTime / 60);
                    const sec = r.completionTime % 60;
                    wsData.push([
                        i + 1, r.teamName, r.p1Name, r.p2Name, r.mobile, r.college, r.department,
                        `${r.score}/30`, `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`,
                        r.yellowCards, r.yellowCards > 0 ? 'FLAGGED' : 'CLEAN'
                    ]);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [
                    {wch:6}, {wch:20}, {wch:20}, {wch:20}, {wch:15},
                    {wch:30}, {wch:20}, {wch:10}, {wch:12}, {wch:12}, {wch:10}
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'Results');
                XLSX.writeFile(wb, `CyberCrest26_Results_${Date.now()}.xlsx`);
            });

            // Download Detailed Results
            document.getElementById('downloadDetailedBtn').addEventListener('click', () => {
                if (teams.results.length === 0) {
                    alert('No results to export!');
                    return;
                }

                const wb = XLSX.utils.book_new();
                
                teams.results.forEach(r => {
                    const wsData = [
                        [`TEAM: ${r.teamName}`],
                        [`Score: ${r.score}/30 | Time: ${Math.floor(r.completionTime/60)}:${String(r.completionTime%60).padStart(2,'0')} | Yellow Cards: ${r.yellowCards}`],
                        [`Registration: ${r.p1Name}, ${r.p2Name} | ${r.mobile} | ${r.college}, ${r.department}`],
                        [],
                        ['#', 'Question', 'Given Answer', 'Correct Answer', 'Result']
                    ];

                    if (r.detailedAnswers) {
                        r.detailedAnswers.forEach((a, i) => {
                            wsData.push([
                                i + 1,
                                a.question,
                                a.givenAnswer,
                                a.correctAnswer,
                                a.isCorrect ? 'CORRECT' : 'WRONG'
                            ]);
                        });
                    }

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    ws['!cols'] = [{wch:5}, {wch:60}, {wch:25}, {wch:25}, {wch:10}];
                    XLSX.utils.book_append_sheet(wb, ws, r.teamName.substring(0, 31));
                });

                XLSX.writeFile(wb, `CyberCrest26_Detailed_${Date.now()}.xlsx`);
            });

            function playNotificationSound() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800;
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.5);
                } catch (e) {}
            }

            window.approveTeam = approveTeam;
            window.clearTeam = clearTeam;
        }
        const audio = document.getElementById('bg-audio');

        // Checks if you refreshed and restores the time
        window.addEventListener('load', () => {
            const savedTime = localStorage.getItem('cybercrest_audio_pos');
            if (savedTime) { audio.currentTime = parseFloat(savedTime); }
        });

        // Plays the music when you click
        function startAudio() {
            audio.play();
        }

        // Remembers the song position every second
        setInterval(() => {
            if (!audio.paused) {
                localStorage.setItem('cybercrest_audio_pos', audio.currentTime);
            }
        }, 1000);
    </script>
</body>
</html>
